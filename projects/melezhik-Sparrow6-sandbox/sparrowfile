#!raku

use Sparky::JobApi;

%*ENV<SP6_DUMP_TASK_CODE> = False;

directory "scm";

git-scm tags()<SCM_URL>, %(
  to => "scm",
  branch => tags<SCM_BRANCH>
);

if tags()<stage> eq "child" {

  task-run "scm/examples/tasks/run-qemu-box", %(
    iso => "{%*ENV<HOME>}/rocky-linux-distro/Rocky-9-GenericCloud-Base.latest.aarch64.qcow2",
    seed => "/tmp/init.iso"
  );

} else {
  # spawns a child job
  my $j = Sparky::JobApi.new;
  $j.queue({
    description => "run qemu box",
    tags => %(
      stage => "child",
      SCM_URL => tags()<SCM_URL>,
      SCM_BRANCH => tags()<SCM_BRANCH>,
    ),
  });

  say "queue spawned job, ",$j.info.raku;

  sleep(220);

  task-run "scm/examples/tasks/stop-qemu-box";

}  

