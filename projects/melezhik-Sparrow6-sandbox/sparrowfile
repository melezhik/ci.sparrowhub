#!raku

use Sparky::JobApi;

%*ENV<SP6_DUMP_TASK_CODE> = False;

directory "scm";

git-scm tags()<SCM_URL>, %(
  to => "scm",
  branch => tags<SCM_BRANCH>
);

if tags()<stage> and tags()<stage> eq "child" {

  task-run "scm/examples/tasks/setup-qemu-image";

  bash "ls -lth {%*ENV<HOME>}/rocky-linux-distro";

  task-run "scm/examples/tasks/run-qemu-box", %(
    iso => "{%*ENV<HOME>}/rocky-linux-distro/Rocky-9-GenericCloud-Base.latest.aarch64.qcow2",
    seed => "/tmp/init.iso"
  );

} elsif tags()<stage> and tags()<stage> eq "child2" {
   say "hello from Sparky";
 } else { 
  task-run "scm/examples/tasks/stop-qemu-box";
  # spawns a child job
  my $j = Sparky::JobApi.new;
  $j.queue({
    description => "run qemu box",
    tags => %(
      stage => "child",
      SCM_URL => tags()<SCM_URL>,
      SCM_BRANCH => tags()<SCM_BRANCH>,
    ),
    sparrowdo => %(
       :bootstrap,
       :ssh_user => "admin",
    ),
  });

  say "queue spawned job, ",$j.info.raku;

  sleep(220);

  $j = Sparky::JobApi.new: :project<qemu_bootstrap>;
  
  $j.queue({
    description => "boostrap qemu box",
    tags => %(
      stage => "child2",
      SCM_URL => tags()<SCM_URL>,
      SCM_BRANCH => tags()<SCM_BRANCH>,
    ),
  });

  say "queue spawned job, ",$j.info.raku;

  sleep(220);

  task-run "scm/examples/tasks/stop-qemu-box";

}  

