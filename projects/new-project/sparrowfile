#!raku

my $git = tags()<repo> || die "repo required";
my $base = "{%*ENV<HOME>}/.sparky";
my $image = tags()<image> || "debian_arm";
my $repo = $git.split("/").tail(2).join("-");

say "git: $git";

say "repo: $repo";

$git ~~ /<-[\w\_\-\.\@\:\/\\\s\^\~]>/ && die "bad symbols found in repo (hackers attempt?)";

bash "timeout 20 git ls-remote --exit-code -h \"$git\"", %(
  :description<check if this is valid git repo>
);

directory "$base/projects/$repo";

template6 "$base/projects/$repo/sparky.yaml", %(
 vars => %(
  :$repo,
  :$git,
  :$image,
 ),
 :template_dir<templates>,
 :template<sparky>,
 #:dry_run, 
);

file "$base/projects/$repo/sparrowfile", %(
  action  => 'create',
  mode    => '644',
  content => "files/sparrowfile".IO.slurp,
);

