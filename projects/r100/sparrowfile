#!raku

use Sparky::JobApi;

bash "raku -V > rakuenv.txt";

Sparky::JobApi.new(:mine).put-file("rakuenv.txt","rakuenv.txt");

my $badge = "![Sparky](https://sparky.sparrowhub.io/badge/{tags()<SPARKY_PROJECT>}?foo=bar)";

"badge.txt".IO.spurt($badge);

Sparky::JobApi.new(:mine).put-file("badge.txt","badge.txt");

"list.txt".IO.spurt(config()<list>);

Sparky::JobApi.new(:mine).put-file("list.txt","list.txt");

my $status = True;

for config()<list><>.sort -> $m {
  my $s = task-run "tasks/install", %(
    module => $m;
  );
  if $s<success> == 0 {
    $status = False;
    Sparky::JobApi.new(:mine).put-file("log.txt","$m.install.log");
  }
}

die "some modules installations have failed" unless $status;
